<!DOCTYPE HTML>
<html>

<head>
  <title>Tasklist</title>

  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- All the web compoent neat stuff -->
  <script src="./external/jquery.min.js"></script>
  <script src="./external/handlebars.js"></script>
  <script src="./external/web-component.js"></script>

  <!-- All the boostrap theming -->
  <link rel="stylesheet" href="./external/bootstrap.min.css">
  <script src="./external/bootstrap.min.js"></script>

  <!-- Markdown support -->
  <script src="./external/marked.min.js"></script>

  <!-- Code highlighting support -->
  <link rel="stylesheet" href="./external/github.min.css">
  <script src="./external/highlight.min.js"></script>

  <!-- Date and time formatting -->
  <script src="./js/interpret-date.js"></script>
  <script src="./js/time-until.js"></script>
  <script src="./js/cookie.js"></script>

  <!--[if lt IE 9]>
    <script src="./external/html5shiv.min.js"></script>
    <script src="./external/respond.min.js"></script>
  <![endif]-->
</head>

<body role="document">

  {{NAVIGATION}}

  <div class="jumbotron"></div>

  <div class="container theme-showcase" role="main">

    <h2>Add task</h1>
    <tasklist-input></tasklist-input>

    <h2>Tasks</h2>
    <tasklist data-source-url="./tasks/json"></tasklist>

    <h2>Local Data</h2>
    <p>The following data is stored locally to your device:</p>
    <div id="local-data"></div>

    <p>Current timestamp: {{NOW}}</p>
  </div>


  <div class="templates">

    <template for="tasklist-input">
      <form>
        <div class="row">
          <div class="col-md-6">
            <label class="sr-only" for="new-event-description">Event</label>
            <div class="input-group mb-2 mr-sm-2 mb-sm-0">
              <div class="input-group-addon"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></div>
              <input type="text" class="form-control mb-2 mr-sm-2 mb-sm-0" id="new-event-description" placeholder="Event description">
            </div>
          </div>
          <div class="col-md-6">
            <label class="sr-only" for="new-event-date">Time or date</label>
            <div class="input-group mb-2 mr-sm-2 mb-sm-0">
              <div class="input-group-addon"><span class="glyphicon glyphicon-calendar" aria-hidden="true"></span></div>
              <input type="text" class="form-control" id="new-event-date" placeholder="Friday after lunch">
              <span class="input-group-btn">
                <button class="btn btn-success" type="button" id="new-event-add"><span class="glyphicon glyphicon-plus" aria-hidden="true"></span> Add</button>
              </span>
            </div>
          </div>
        </div>
      </form>

      <div id="new-event-preview"></div>
    </template>

    <script for="shared" type="text/javascript">
      String.prototype.hashCode = function() {
        var hash = 0, i, chr, len;
        if (this.length === 0) return hash;
        for (i = 0, len = this.length; i < len; i++) {
          chr   = this.charCodeAt(i);
          hash  = ((hash << 5) - hash) + chr;
          hash |= 0; // Convert to 32bit integer
        }
        return hash;
      };

      function removeDuplicateTasks(tasks) {
        var hashMap = {};
        tasks.forEach(function(item) {
          var hash = (item.text + item.dateString).hashCode();
          hashMap[hash] = item;
        });

        result = [];
        for(var key in hashMap) {
          result.push(hashMap[key]);
        }
        return result;
      }

      function enhanceTask(task) {
        task.referenceDate = new Date(task.entryDate * 1000);
        task.interpetedDate = interpretDate(task.referenceDate, task.dateString);
        task.daysUntil = timeUntil(task.interpetedDate);
        task.unit = task.daysUntil.unit;
        task.past = task.daysUntil.past ? 'past' : 'future';
        task.class = ('unit-' + task.unit + ' ' + task.past).trim();
        task.interpetedDate.string = task.interpetedDate.toUTCString();
        task.referenceDate.string = task.referenceDate.toUTCString();

        return task;
      }

      function readLocalTasks() {
        return Cookies.read().tasklist || {};
      }

      function writeLocalTasks(tasklist) {
        tasklist.tasks = removeDuplicateTasks(tasklist.tasks);
        Cookies.write({
          tasklist: tasklist
        }, 100, '/tasklist');
      }

      function deleteTask(task) {
        var tasklist = readLocalTasks();
        tasklist.tasks = tasklist.tasks.filter(function(item) {
          return item.text !== task.text;
        });
        writeLocalTasks(tasklist);
      }

      function displayCookies() {
        var localData = readLocalTasks();
        $('#local-data').html('<pre>' + JSON.stringify(localData, null, 2) + '</pre>');
      }

      function addNewEntry(task) {
        var localTasks = readLocalTasks();
        localTasks.tasks = localTasks.tasks || [];
        if (task.dateString && task.text) {
          localTasks.tasks.push(task);
          writeLocalTasks(localTasks);
          displayCookies();
        }
      }

      function renderTaskList() {
        var Tasklist = Component.configure('tasklist');
        Tasklist.apply(function(instance) {
          instance.render();
        });
      }

      displayCookies();
    </script>

    <script for="tasklist-input" type="text/javascript">
      $(function() {
        TasklistInput = Component.configure('tasklist-input');

        TasklistInput.on('preRenderStep', function(instance) {

        });

        TasklistInput.apply(function(instance) {
          instance.render();

          $description = $('#new-event-description');
          $date = $('#new-event-date');
          $add = $('#new-event-add');
          $preview = $('#new-event-preview');

          function updateAddEntryPreview() {
            var task = enhanceTask({
              entryDate: Date.now() / 1000,
              dateString: $date.val(),
              text: $description.val()
            });
            $preview.html(`<tasklist-item class="${task.class}" date-string="${task.dateString}" entry-date="${task.entryDate}" days-until="${task.daysUntil.string}" reference-date="${task.referenceDate.string}" interpeted-date="${task.interpetedDate.string}" local="${task.local}">${task.text}</tasklist-item>`);
            Component.scanForComponents(document.getElementById('new-event-preview'))
          }

          $description.on('change', function(event) {
            console.log('Description:', event.target.value)
            updateAddEntryPreview()
          });

          $date.on('change', function(event) {
            console.log('Date:', event.target.value)
            updateAddEntryPreview()
          });

          $add.on('click', function(event) {
            updateAddEntryPreview()
            var task = {
              entryDate: Date.now() / 1000,
              dateString: $date.val(),
              text: $description.val()
            };
            addNewEntry(task);
            displayCookies();
            $description.val('');
            $date.val('');
            renderTaskList();
          });

        });
      });
    </script>

    <template for="tasklist-item">
      <p>
        {{#if local}}
        <span class="glyphicon glyphicon-flash" aria-hidden="true"></span>
        <span class="glyphicon glyphicon-trash delete button" aria-hidden="true"></span>
        {{else}}
        <span class="glyphicon glyphicon-cloud" aria-hidden="true"></span>
        {{/if}}
        <b>{{days-until}}</b> : {{content}}, <i style="opacity: 0.3;">{{date-string}}</i>
        <span class="date">Interpretted: {{interpeted-date}}</span>
        <span class="date">Reference: {{reference-date}}</span>
      </p>
    </template>

    <script for="tasklist" type="text/javascript">
      $(function() {
        TasklistItem = Component.configure('tasklist-item');

        TasklistItem.on('renderComplete', function(instance) {
          $(instance.element).find('span.delete.button').on('click', function() {
            console.log('Delete instance', '"' + instance['date-string'] + '"', '"' + instance.content + '"');
            deleteTask({
              dateString: instance['date-string'],
              entryDate: instance['entry-date'],
              text: instance.content
            });
            renderTaskList();
          });
        });
      });
    </script>

    <style for="tasklist-item">
      .row > .col-md-6 {
        margin-bottom: 5px;
      }

      tasklist-item {
        display: block;
        padding: 5px 0;
      }

      tasklist-item>p>span.date {
        display: none;
      }

      tasklist-item>p>span.delete {
        opacity: 0.1;
        position: absolute;
        top: 3px;
        right: 3px;
        padding: 5px;
      }

      tasklist-item>p>span.delete:hover {
        opacity: 1.0;
      }

      tasklist-item>p>span.delete:active {
        color: white;
      }

      tasklist-item>p {
        padding: 6px 8px;
        border-radius: 5px;
        background: #999;
        margin: 0;
        position: relative;
      }

      tasklist-item .glyphicon {
        font-size: 110%;
        vertical-align: text-top;
      }

      tasklist-item.past {
        opacity: 0.4;
      }

      tasklist-item.unit-second.past, tasklist-item.unit-minute.past, tasklist-item.unit-hour.past {
        opacity: 1.0;
      }

      tasklist-item.unit-day p {
        background: #AAF;
      }

      tasklist-item.unit-week p {
        background: #FE9;
      }

      tasklist-item.unit-month p {
        background: #AE8;
      }

      tasklist-item.unit-year p {
        background: #CFC;
      }

      tasklist-item.past p {
        background: #AAA;
      }

      tasklist-item.unit-minute p, tasklist-item.unit-second p, tasklist-item.unit-millisecond p {
        background: #F96;
      }

      tasklist-item.unit-hour p {
        background: #FA6;
      }
    </style>

    <template for="tasklist">
      {{#each tasks}}
      <tasklist-item class="{{class}}" date-string="{{dateString}}" entry-date="{{entryDate}}" days-until="{{daysUntil.string}}" reference-date="{{referenceDate.string}}" interpeted-date="{{interpetedDate.string}}" local="{{local}}">{{text}}</tasklist-item>
      {{/each}}
    </template>

    <script for="tasklist" type="text/javascript">
      $(function() {
        var Tasklist = Component.configure('tasklist');

        Tasklist.on('preRenderStep', function(instance) {

          instance.tasks = (instance.tasks || []).filter(function(task) {
            return !task.local;
          });
          var localTasks = readLocalTasks().tasks.forEach(function(task) {
            task.local = true;
            instance.tasks.push(task);
          });
          instance.tasks.forEach(enhanceTask);

          instance.tasks = removeDuplicateTasks(instance.tasks);

          instance.tasks = instance.tasks.sort(function(a, b) {
            return a.interpetedDate.getTime() - b.interpetedDate.getTime();
          });

        });

        Tasklist.apply(function(instance) {
          instance.render();
        });
      });
    </script>
  </div>
</body>

</html>
